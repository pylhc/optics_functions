# optics_functions

[![Cron Testing](https://github.com/pylhc/optics_functions/workflows/Cron%20Testing/badge.svg)](https://github.com/pylhc/optics_functions/actions?query=workflow%3A%22Cron+Testing%22)
[![Code Climate coverage](https://img.shields.io/codeclimate/coverage/pylhc/optics_functions.svg?style=popout)](https://codeclimate.com/github/pylhc/optics_functions)
[![Code Climate maintainability (percentage)](https://img.shields.io/codeclimate/maintainability-percentage/pylhc/optics_functions.svg?style=popout)](https://codeclimate.com/github/pylhc/optics_functions)
[![GitHub last commit](https://img.shields.io/github/last-commit/pylhc/optics_functions.svg?style=popout)](https://github.com/pylhc/optics_functions)
[![GitHub release](https://img.shields.io/github/release/pylhc/optics_functions.svg?style=popout)](https://github.com/pylhc/optics_functions)

This package provides functions to calculate various optics parameters from **MAD-X TWISS** outputs.

## Getting Started

The package depends heavily on another one of our packages, `tfs-pandas`.
Installation is easily done via `pip`. The package is then used as `optics_functions`.

```
pip install optics_functions
```

## Documentation

- Autogenerated docs via `Sphinx` can be found at <https://pylhc.github.io/optics_functions/>.
- General documentation of the OMC-Team is located at <https://pylhc.github.io/>

## Description

This package serves as a library of functions to calculate various optics parameters such as RDTs and coupling from a MAD-X twiss output.
The functionality mainly manipulates and returns TFS files or `TfsDataFrame` objects from the `tfs-pandas` package.


### Usage Examples 
Coupling Example:

```python
import logging
import sys

import tfs  # tfs-pandas

from optics_functions.coupling import coupling_from_cmatrix, closest_tune_approach
from optics_functions.utils import split_complex_columns

logging.basicConfig(stream=sys.stdout, level=logging.INFO, format="%(message)s")

# read MAD-X twiss output
df_twiss = tfs.read("twiss.tfs", index="NAME")

# calculate coupling from the cmatrix
df_coupling = coupling_from_cmatrix(df_twiss)

# calculate the closest tune approach from the complex rdts
df_dqmin = closest_tune_approach(df_coupling,
                                 qx=df_twiss.Q1, qy=df_twiss.Q2,
                                 method='calaga'
                                 )

# do something with the data.

# write out
# as the writer can only handle real data, 
# you need to split the rdts into real and imaginary parts before writing
tfs.write("coupling.tfs",
          split_complex_columns(df_coupling, columns=["F1001", "F1010"]),
          save_index="NAME"
          )

```

RDT Example:

```python
import logging
import sys

import tfs  # tfs-pandas

from optics_functions.rdt import calculate_rdts, generator, jklm2str
from optics_functions.utils import prepare_twiss_dataframe, split_complex_columns

logging.basicConfig(stream=sys.stdout, level=logging.INFO, format="%(message)s")

# read MAD-X twiss output
df_twiss = tfs.read("twiss.tfs", index="NAME")

# check correct signs (i.e if beam==4), merge twiss and errors, 
# add empty K(S)L columns if needed
rdts = [jklm2str(*jklm) for jklm in generator(orders=[2])[2]]
df_twiss = prepare_twiss_dataframe(beam=1, df_twiss=df_twiss,
                                   df_errors=None, max_order=5
                                   )
df_rdts = calculate_rdts(df_twiss, rdts=rdts,
                         loop_phases=True,  # loop over phase-advance calculation, slower but saves memory
                         feeddown=2,  # include feed-down up to this order
                         real=False,  # complex output
                         )

# do something with the rdts.

# write out
# as the writer can only handle real data, either set real = True above 
# or split the rdts into real and imaginary parts before writing
tfs.write("rdts.tfs",
          split_complex_columns(df_rdts, columns=rdts),
          save_index="NAME"
          )

```

## Quality checks

- Unit and accuracy tests are run automatically through CI [Github Actions](https://github.com/pylhc/optics_functions/actions). See our workflows in this [readme](.github/workflows/README.md).
- Additional checks for code-complexity, design-rules, test-coverage and duplication are made through [CodeClimate](https://codeclimate.com/github/pylhc/optics_functions).
- Pull requests implementing functionality or fixes are merged into the master branch after passing CI, and getting a reviewer's approval.

### Changelog

See the [CHANGELOG](CHANGELOG.md) file.

## Authors

* **pyLHC/OMC-Team** - *Working Group* - [pyLHC](https://github.com/orgs/pylhc/teams/omc-team)

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.